---
title: Raft-共识算法
categories: 技术研究
date: 2024-08-14 11:01:52
tags: [分布式, raft, 一致性协议, go]
cover:
top_img:
---

# Raft-共识算法

> 论文链接：[https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf](https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf)

`Raft`是一种管理复制日志的共识算法，共识算法的存在能够使得一组机器作为一个连贯的整体进行工作，即使部分成员发生故障也能够继续运行。

`Raft`采用了特定的技术来提高可理解性，包括分解（Raft将领导者选举、日志复制和安全性分开处理）和状态空间压缩。具备一下几项新特性：

* 强邻导者

    `Raft`使用了一种比其他共识算法更强的领导形式，如：日志条目只从领导流向其他服务器，这样大大简化了对复制日志的管理，让raft更易于理解。

* 领导者选举

    `Raft`使用随机定时器来选举领导者。实现的过程是在心跳机制中增加少量内容，这种机制对于任何共识算法都是必需的。

* 成员变更

    `Raft`的集群成员变更机制使用了一种新的联合共识方法，在转换期间两个不同配置的多数群体相互重叠。这使得集群在配置变更期间可以正常运行。

## 复制状态机

共识算法通常再复制状态机的背景下出现，在这种方法中，一组服务器上的状态机计算相同状态的多个副本，即使其中一些服务器发生故障也能继续运行。复制状态机被用于解决分布式系统中的各种容错问题。

![raft-01](paper-raft/raft-01.png)

复制状态机通常使用一个复制日志来实现，如上图，每个服务器存储一个包含一系列命令的日志，其状态机按顺序执行这些命令。每个日志包含相同顺序的相同指令，因此每个状态机处理相同的命令序列，由于状态机是确定的，它们计算出相同的状态和相同的输出序列。

共识算法需要保持复制日志的一致性，服务器上的共识模块接收来自客户端的命令并将其添加到日志中。它与其他服务器上的共识模块通信，以确保每个日志最终包含相同的顺序的相同请求。即使某些服务器发生故障，一旦命令被正确的复制，每个服务器的状态机按日志顺序处理它们，并将输出返回给客户端。

一个实用的共识算法通常具有以下属性：

* 在所有非拜占庭条件下（包括网络延迟、分区、数据包丢失、重复和乱序）确保安全性

* 在任何多数服务器正常工作并能彼此通信以及与客户端通信的情况下，完全功能（可用）。因此，一个典型的五台服务器的集群可以容忍任何两台服务器的故障。

* 不依赖于时间来确保日志的一致性。错误的始终和极端的消息延迟至多会引发可用性的问题。

* 在正常情况下，一旦集群中的多数服务器响应了单轮远程过程调用，命令就可以完成；少数慢速服务器不会影响整体系统性能。

论文中提到，在设计Raft时，有几个目标：

它必须为系统构建提供一个完整且使用的基础，以显著减少开发人员所需的设计工作量

它必须对常见的操作高效

可理解性：必须让广大受众能够轻松理解算法，此外，系统构建者必须能够发展对算法的直观理解，以便于在实际实现中进行必要的拓展。

在raft的设计中使用了两种普遍使用的技术：

1、尽可能的将问题分解成独立的部分，这些部分可以分别解决、解释和理解。例如将领导者选举、日志复制、安全性和成员变更分开处理。

2、通过减少要考虑的状态数量来简化状态空间，使系统更加连贯，并尽可能消除不确定性。

## Raft算法

`Raft`通过首先选举出一位公认的领导者来实现共识，然后赋予领导者完全的职责来管理复制日志。领导者从客户端接收日志条目，将其复制到其它服务器，并告诉服务器何时可以安全地将日志条目应用到它们的状态机上，通过有一个领导者，简化了复制日志的管理。领导者可以在不咨询其它服务器的情况下决定在日志中放置新条目的位置，数据以简单的方式从领导者刘翔其它服务器。领导者可能会失败或者与其它服务器断开链接，这种情况下将选举出一位新领导者。


### Raft基本原理

一个`Raft`集群包含多个服务器，五台服务器是一个典型的数量，允许系统容忍两次故障。在任何给定时间，每个服务器都处于三种状态之一：领导者、追随者或候选者。在正常操作中，只有一位领导者，所有其它服务器都是追随者。追随者是被动的：他们不发出任何请求，只是响应来自领导者和候选者的请求。领导者处理所有客户端请求（如果客户端联系追随者，追随者会将其重定向至领导者）。第三种状态是候选者，用于现任领导者失败时选举新领导者。

[raft-04](paper-raft/raft-04.png)

`Raft`将时间分为任期，每个任期长度不定，任期以选举开始，期间一个或多个候选者尝试称为领导者，如果候选者赢得选举，它将担任该任期的领导者。在某些情况下，如果选举导致平票，该任期则以没有领导者结束，新的任期将很快开始，`Raft`确保在一个给定的任期内至多只有一位领导者。

在`Raft`中，任期充当逻辑始终，允许服务器检测过时的信息，例如过时的领导者。每个服务器存储当前任期号，该任期号随着时间的推移单调增加。每当服务器通信时，当前任期号都会交换；如果一个服务器当前任期号小于另一个服务器的任期号，则更新其当前任期号为较大值。如果候选者或领导者发现其任期号已过时，会立即转换为追随者状态。如果服务器收到带有过时任期号的请求，它将拒绝该请求。

`Raft`服务器使用远程过程调用`RPC`进行通信，基本共识算法只需要两种类型的`RPC`。候选者在选举期间发起`RequestVote` RPC，领导者则发起`AppendEntries` RPC来复制日志条目和提供一种心跳形式。也可以拓展第三种用于在服务器之间传输快照的`RPC`，服务器在未及时收到响应时会重试RPC，并且会并发发出RPC以获得最佳性能

### 领导者选举

`Raft`使用心跳机制出发领导者选举。当服务器启动时，他们首先作为追随者，服务器只要接收到来自领导者或者候选者的有效`RPC`，就会保持在追随者状态。领导者定期向所有追随者发送心跳（不带日志条目的AppendEntries RPC），以保持其处于存活状态。如果追随者一定时间内未收到通信（称为选举超时），则它会假设不存在合格的领导者存在，并开始选举新领导者。

为了开始选举，追随者将其当前任期号加一，并转换为候选者状态。然后它为自己投票，并同时向集群中的其它服务器发出`RequestVote RPC`。候选者将保持在此状态，直到发生以下三种情况之一：1、它赢得选举（获得半数以上投票），2、另一个服务器成为领导者，3、一段时间过去，仍未选出领导者。

* 赢得选举

如果候选者在同一任期内从多数服务器获得投票，它将赢得选举。每个服务器在一个任期内至多只会为一个候选者进行投票，遵循的是先到先得的原则，多数规则确保了在特定的任期内最多只有一个候选者能够赢得选举。一旦候选者赢得选举，它就称为领导者，让后向所有其它服务器发送心跳消息，以同步确立其领导者权威。

* 另一个服务器成为领导者

在等待投票期间，候选者可能收到来自其它服务器的`AppendEntries RPC`，声称其为领导者，在这些请求中，包含了另一个服务器的任期号，如果收到的任期号大于或者等于当前任期号，此时正在等待投票的候选者会承认另一个服务器的领导者合法性并返回追随者状态。如果小于当前服务器任期号，则候选者会拒绝该`RPC`请求，会认为这是一个已经失效的`RPC`请求，并继续处于候选者状态。

* 平票

如果有多个追随者同时成为候选者则可能会出现平票的情况，当发生这种情况时，每个候选者将超时并通过增加其任期号启动新一轮选择，并发起另一轮的`RequestVote RPC`。

在我们实现的过程中，我们会使用随机选举来确保避免平票的现象，选举超时会从一个固定的区间内随机选择一个时间（150-300ms）。这会将服务器分散开来，从而在大多数情况下只有一个服务器会超时；它赢得选举并在其它服务器超时之前发送心跳。同样，每个候选者在选举开始时重新启动其随机选举超时，并在超时之前等待，这减少了新一轮选举中再次出现分票的可能性。

### 日志复制

一旦领导者选出，他就会开始处理客户端的请求。每个客户端请求包含一个要由复制状态机执行的命令。领导者将该命令作为新条目添加到其日志中，然后并行的向其它服务器发出`AppendEntries RPC`以复制该条目。当该条目被安全的复制后，领导者将该条目应用到其状态机，并将执行结果返回给客户端。如果追随者崩溃或运行缓慢，或者网络数据包丢失，领导者将无限期重试`AppendEntries RPC`（即使在它响应客户端之后），直到所有追随者最终存储所有日志条目为止。

[raft-06](paper-raft/raft-06.png)

日志的组织如图所示，每个日志条目存储一个状态机命令以及领导者接收到该条目时的任期号。日志条目中的任期号用于检测日志之间的不一致每个条目还具有一个整数索引，用于表示其在日志中的位置。

领导者决定何时可以将日志条目安全的应用到状态机中；此类条目称为以提交条目。raft保证已提交条目是持久的，并且最终会被所有可用的状态机执行。当创建该条目的领导者已在大多数服务器上复制该条目时，该条目即为已提交条目。这也会提交领导者日志中所有先前的条目，包括之前领导者创建的条目。领导者跟踪它直到的已提交条目的最高索引，并在未来的`AppendEntries RPC`中包含该索引，以便其它服务器最终获知。一旦追随者得知日志条目已提交，它会按日志顺序将条目应用到本地状态机。




